# 音乐串烧一键工具

一键完成音乐串烧制作的全流程工具，整合了三个功能：**歌曲分类** → **变调变速** → **音频拼接**

## ✨ 功能特性

### 自动化流程
1. **歌曲分类**：根据调号（key）和速度（bpm）的差异自动分类歌曲
2. **变调变速**：对分类的歌曲进行变调、变速处理以匹配锚定歌曲
3. **音频拼接**：按规则顺序拼接处理后的音频，生成最终成品

### 界面特性
- 🎨 现代化图形界面（基于PyQt6）
- 📁 支持拖拽文件和目录
- 📊 实时显示每个步骤的处理进度
- 📝 详细的运行日志记录
- ⚙️ 可自定义分类和拼接参数

## 📦 安装与使用

### 方式一：使用EXE文件（推荐）

**直接下载打包好的EXE文件，无需安装Python环境！**

1. 下载 `MusicMashupTool.exe`
2. 下载并安装 ffmpeg（必需）：
   - 下载地址：https://ffmpeg.org/download.html
   - 解压后将 `ffmpeg.exe` 放在EXE同目录下，或添加到系统PATH
3. 双击运行 `MusicMashupTool.exe`

### 方式二：从源码运行

#### 系统要求
- Python 3.8+
- Windows / macOS / Linux

#### 安装步骤

```bash
# 1. 安装Python依赖
pip install -r requirements.txt

# 2. 安装ffmpeg
# Windows: 从 https://ffmpeg.org/download.html 下载
# macOS: brew install ffmpeg
# Linux: sudo apt-get install ffmpeg

# 3. 运行程序
python main.py
```

### 方式三：自行打包EXE

```bash
# 安装打包工具
pip install pyinstaller

# 运行打包脚本
python build_exe.py

# 或直接使用批处理
build.bat
```

打包后的EXE文件位于 `dist/MusicMashupTool.exe`

## 🚀 快速开始

### 启动程序

```bash
python main.py
```

### 使用步骤

1. **准备输入文件**
   - 原始歌曲表格（Excel格式）
   - 音频文件目录

2. **选择文件**
   - 拖拽或点击浏览按钮选择表格文件
   - 拖拽或选择音频文件所在目录
   - 选择输出目录

3. **设置参数**
   - 调整静音间隙时长（默认0.5秒）

4. **开始处理**
   - 点击"开始处理"按钮
   - 实时查看每个步骤的进度
   - 等待处理完成

5. **查看结果**
   - 分类表格：`输出目录/原始表格名_分类结果.xlsx`
   - 音频成品：`输出目录/*.mp3`（直接保存在输出目录根目录）

## 📋 Excel表格格式要求

### 必需列
- **歌名** 或 **name**：歌曲名称
- **调号** 或 **key**：音乐调性（如 C, C#, D, D#, E, F, F#, G, G#, A, A#, B）
- **速度** 或 **bpm**：节拍数（数字）

### 可选列
- **ID**：歌曲唯一标识符（用于匹配音频文件）
- **Chord Ai**：和弦AI信息
- **歌手** 或 **歌手名**：歌手名称
- **副歌开始时间**：副歌开始的时间点
- **副歌结束时间**：副歌结束的时间点
- **段落剪切时间**：段落剪切的时间点
- **性别**：歌手性别（用于分类匹配）

### 表格示例

| ID    | 歌名     | 歌手   | 调号 | 速度 | 性别 |
|-------|---------|--------|------|------|------|
| 88810 | 爱你没差 | 周杰伦 | C    | 75   | 男   |
| 88588 | 安静    | 周杰伦 | Bb   | 72   | 男   |
| 12345 | 告白气球 | 周杰伦 | C    | 74   | 男   |

## 🎵 音频文件要求

### 文件命名规范

#### 方式1：使用ID（推荐）
```
音频目录/
├── 88810-前段副歌.mp3
├── 88810-后段副歌.mp3
├── 88588-前段副歌.mp3
├── 88588-后段副歌.mp3
└── ...
```

#### 方式2：使用歌名
```
音频目录/
├── 爱你没差-前段副歌.mp3
├── 爱你没差-后段副歌.mp3
├── 安静-前段副歌.mp3
├── 安静-后段副歌.mp3
└── ...
```

### 支持的音频格式
- WAV
- MP3
- M4A
- FLAC
- AAC
- OGG

### 重要说明
- 每首歌需要两个片段：**前段副歌** 和 **后段副歌**
- 文件命名中的ID或歌名必须与Excel表格中的对应
- 程序会自动识别并匹配音频文件

## 🔧 处理流程详解

### 步骤1：歌曲分类

**功能**：
- 读取原始表格中的所有歌曲
- 每首歌作为锚点，查找与其匹配的歌曲
- 匹配条件：
  - 调号相差不超过一个全音（2个半音）
  - 速度相差不超过5 BPM
  - 性别相同

**输出**：
- 分类后的Excel表格（每个Sheet代表一个锚定歌曲及其匹配歌曲）
- 保存在 `输出目录/1-分类结果/`

### 步骤2：变调变速

**功能**：
- 读取分类表格的每个Sheet
- 对每个匹配歌曲进行处理：
  - **变调**：根据调号差异进行升降调
  - **变速**：根据BPM差异进行变速
- 使锚定歌曲与匹配歌曲的调号和速度一致

**输出**：
- 处理后的音频文件（临时文件，处理完成后自动删除）

### 步骤3：音频拼接

**功能**：
- 读取分类表格，按ID两两配对
- 按以下顺序拼接每一对：
  ```
  静音 → A前段副歌 → 静音 → B前段副歌 → 静音 → 
  A后段副歌 → 静音 → B后段副歌 → 静音
  ```
- 生成最终成品

**输出**：
- 拼接后的音频文件（MP3格式，320kbps）
- 直接保存在输出目录根目录

## ⚙️ 参数说明

### 分类参数

#### 调号区间
- **作用**：控制歌曲分类时调号的匹配范围
- **范围**：0 ~ 6 个半音
- **默认值**：2 个半音（一个全音）
- **建议**：
  - 严格匹配（最佳音质）：0-1
  - 标准匹配（推荐）：2
  - 宽松匹配（更多组合）：3-4

#### 速度区间
- **作用**：控制歌曲分类时速度的匹配范围
- **范围**：0 ~ 20 BPM
- **默认值**：5 BPM
- **建议**：
  - 严格匹配（最佳音质）：0-3
  - 标准匹配（推荐）：5
  - 宽松匹配（更多组合）：8-10

**💡 提示：** 参数越小，匹配到的歌曲越少，但变调变速幅度越小，音质越好。

### 拼接参数

#### 静音间隙
- **作用**：在音频片段之间添加静音
- **范围**：0 ~ 5.0 秒
- **默认值**：0.5 秒
- **建议**：
  - 快节奏歌曲：0.3 ~ 0.5 秒
  - 慢节奏歌曲：0.5 ~ 1.0 秒
  - 无缝拼接：0 秒

## 📊 输出结构

```
输出目录/
├── 原始表格名_分类结果.xlsx      # 步骤1：分类表格
├── 爱你没差+安静.mp3             # 步骤3：音频成品
├── 告白气球+简单爱.mp3           # 步骤3：音频成品
└── ...                          # 其他成品

注：步骤2的处理后音频保存在临时目录，完成后自动删除
```

## 🔍 常见问题

### Q: 程序无法启动
**A:** 检查以下事项：
1. Python版本是否为3.8+
2. 是否已安装所有依赖包（`pip install -r requirements.txt`）
3. 查看错误日志了解具体原因

### Q: 找不到音频文件
**A:** 请确认：
1. 音频文件命名是否符合规范（ID-前段副歌、ID-后段副歌）
2. 文件名中的ID或歌名是否与Excel表格一致
3. 音频格式是否为支持的格式

### Q: 升降调后音质变差
**A:** 建议安装 pyrubberband 库以获得更高质量的音质：
```bash
# Windows
pip install rubberband

# macOS
brew install rubberband && pip install pyrubberband

# Linux
sudo apt-get install librubberband-dev && pip install pyrubberband
```

### Q: 处理速度慢
**A:** 
- 音频处理是CPU密集型操作，处理大量文件需要时间
- 可以在日志中查看详细进度
- 考虑使用更快的CPU或减少待处理文件数量

### Q: pydub报错找不到ffmpeg
**A:** 需要安装ffmpeg：
- Windows: 从 https://ffmpeg.org/download.html 下载并添加到PATH
- macOS: `brew install ffmpeg`
- Linux: `sudo apt-get install ffmpeg`

### Q: 某些歌曲没有被分类
**A:** 可能原因：
1. 调号或速度与其他歌曲差异过大
2. 性别不匹配
3. 数据格式有误

### Q: 拼接时提示找不到音频片段
**A:** 确认：
1. 步骤2（变调变速）是否成功完成
2. `2-处理后音频` 目录中是否存在对应的Sheet文件夹
3. 每首歌是否有前段副歌和后段副歌两个文件

## 📝 技术说明

### 调号转换
- 支持字母调号：C, C#, Db, D, D#, Eb, E, F, F#, Gb, G, G#, Ab, A, A#, Bb, B
- 支持大小调：Cm, Am 等（大小调差异会被忽略）
- 自动计算最短半音差（考虑八度循环）

### 变速算法
- 变速率 = 锚定歌曲BPM ÷ 匹配歌曲BPM
- 使用 librosa 的 time_stretch 算法
- 保持音高不变

### 立体声处理
- 自动识别单声道/立体声
- 立体声会分别处理左右声道
- 保持原始采样率

## 🛠️ 开发说明

### 项目结构
```
音乐串烧一键工具/
├── main.py                  # 主程序入口
├── gui.py                   # GUI界面
├── pipeline_worker.py       # 流程处理工作线程
├── step1_classifier.py      # 步骤1：歌曲分类
├── step2_pitch_tempo.py     # 步骤2：变调变速
├── step3_concat.py          # 步骤3：音频拼接
├── requirements.txt         # Python依赖
├── build_exe.py             # EXE打包脚本
├── build.bat                # 一键打包批处理
├── MusicMashupTool.spec     # PyInstaller配置
├── app_icon.ico             # 应用图标
└── README.md                # 使用说明
```

### 依赖库
- **PyQt6**：图形界面
- **pandas**：数据处理
- **openpyxl**：Excel读写
- **librosa**：音频处理
- **soundfile**：音频读写
- **pydub**：音频拼接
- **pyrubberband**（可选）：高质量升降调

## 📄 许可证

本项目仅供学习和个人使用。

## 🤝 贡献

欢迎提交问题和改进建议！

## 📧 联系方式

如有问题，请通过以下方式联系：
- 提交 Issue
- 发送邮件

---

**注意**：本工具仅用于个人学习和研究，请遵守相关法律法规，尊重版权。

